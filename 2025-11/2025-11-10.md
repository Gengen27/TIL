SQL学習メモ
===================

1. 前提：テーブルとレコード
-----------------------
- テーブルは列（カラム）と行（レコード）で構成される。
- 各カラムにはデータ型と役割がある（例：`id`、`name`、`age`）。
- スキーマはテーブル構造の定義。データベース設計の基礎。
- 例：`employees(id INTEGER PRIMARY KEY, name TEXT, age INTEGER, department TEXT)` のように、カラム名と型を宣言してテーブルを作成する。
- 具体例として従業員テーブルに `id=1, name='Alice', age=30, department='Sales'` というレコードが1行登録される。
- サンプルDDLと初期データ：
```sql
CREATE TABLE employees (
  id INTEGER PRIMARY KEY,
  name TEXT,
  age INTEGER,
  department TEXT,
  salary INTEGER,
  joined_at DATE
);

INSERT INTO employees (id, name, age, department, salary, joined_at) VALUES
  (1, 'Alice', 30, 'Sales', 420000, '2023-04-01'),
  (2, 'Bob', 27, 'Marketing', 380000, '2023-05-12'),
  (3, 'Carol', 35, 'Sales', 500000, '2022-11-20'),
  (4, 'Dave', 29, 'Engineering', 600000, '2024-01-05'),
  (5, 'Eve', 41, 'Sales', 550000, '2021-09-17');
```
- 挿入後のテーブルイメージ：

| id | name  | age | department  | salary | joined_at  |
|----|-------|-----|-------------|--------|------------|
| 1  | Alice | 30  | Sales       | 420000 | 2023-04-01 |
| 2  | Bob   | 27  | Marketing   | 380000 | 2023-05-12 |
| 3  | Carol | 35  | Sales       | 500000 | 2022-11-20 |
| 4  | Dave  | 29  | Engineering | 600000 | 2024-01-05 |
| 5  | Eve   | 41  | Sales       | 550000 | 2021-09-17 |

2. SELECT文の基本形
-----------------
- 基本構文：`SELECT 列 FROM テーブル WHERE 条件 ORDER BY 並べ替え LIMIT 件数;`
- `SELECT *` は全列取得。必要な列のみ指定すると可読性と性能が向上。
- `ORDER BY` で並べ替え、`LIMIT` で取得件数を制御できる。
- 例：部署が営業の従業員名と年齢だけを取得する場合は `SELECT name, age FROM employees WHERE department = 'Sales';`
- 例：入社が早い順に5名を取得するなら `SELECT * FROM employees ORDER BY joined_at ASC LIMIT 5;`
- 実行例と結果：
```sql
SELECT name, age FROM employees WHERE department = 'Sales';
```
| name  | age |
|-------|-----|
| Alice | 30  |
| Carol | 35  |
| Eve   | 41  |

```sql
SELECT * FROM employees ORDER BY joined_at ASC LIMIT 5;
```
| id | name  | age | department  | salary | joined_at  |
|----|-------|-----|-------------|--------|------------|
| 5  | Eve   | 41  | Sales       | 550000 | 2021-09-17 |
| 3  | Carol | 35  | Sales       | 500000 | 2022-11-20 |
| 1  | Alice | 30  | Sales       | 420000 | 2023-04-01 |
| 2  | Bob   | 27  | Marketing   | 380000 | 2023-05-12 |
| 4  | Dave  | 29  | Engineering | 600000 | 2024-01-05 |

3. WHERE句の活用
---------------
- 比較演算（`=`, `<>`, `>`, `<` など）で条件を作成。
- 複数条件は `AND`／`OR`、否定は `NOT` を使用。
- 文字列の部分一致には `LIKE` とワイルドカード `%` を利用。
- 例：年齢が25〜35歳で営業部に所属する従業員を探す `SELECT name FROM employees WHERE age BETWEEN 25 AND 35 AND department = 'Sales';`
- 例：`LIKE` を使い、名前が「A」で始まる従業員を取得 `SELECT name FROM employees WHERE name LIKE 'A%';`
- 実行例と結果：
```sql
SELECT name FROM employees WHERE age BETWEEN 25 AND 35 AND department = 'Sales';
```
| name  |
|-------|
| Alice |
| Carol |

```sql
SELECT name FROM employees WHERE name LIKE 'A%';
```
| name  |
|-------|
| Alice |

4. GROUP BYと集計関数
-------------------
- `GROUP BY` で同じ値をまとめ、`COUNT` や `AVG` などの集計関数を適用する。
- 集計結果は通常 `ORDER BY` と組み合わせて読みやすく整列させる。
- 実行例と結果：
```sql
SELECT
  department,
  COUNT(*) AS member_count,
  AVG(salary) AS avg_salary
FROM employees
GROUP BY department
ORDER BY avg_salary DESC;
```
| department  | member_count | avg_salary |
|-------------|--------------|------------|
| Engineering | 1            | 600000     |
| Sales       | 3            | 490000     |
| Marketing   | 1            | 380000     |

```sql
SELECT
  department,
  AVG(salary) AS avg_salary
FROM employees
GROUP BY department
HAVING AVG(salary) >= 450000;
```
| department  | avg_salary |
|-------------|------------|
| Engineering | 600000     |
| Sales       | 490000     |

5. ORDER BYとLIMITの応用
--------------------
- `ORDER BY` では複数列や式を使い、優先順位を細かく制御できる。
- `LIMIT` と `OFFSET` を組み合わせると、ページング処理（n件ずつ表示）が実現できる。
- 実行例と結果：
```sql
SELECT name, department, salary
FROM employees
ORDER BY salary DESC
LIMIT 3;
```
| name  | department  | salary |
|-------|-------------|--------|
| Dave  | Engineering | 600000 |
| Eve   | Sales       | 550000 |
| Carol | Sales       | 500000 |

```sql
SELECT name, department, salary
FROM employees
ORDER BY salary DESC
LIMIT 2 OFFSET 2;
```
| name  | department | salary |
|-------|------------|--------|
| Carol | Sales      | 500000 |
| Alice | Sales      | 420000 |

6. INSERT／UPDATE／DELETE
----------------------
- データを追加する `INSERT`、更新する `UPDATE`、削除する `DELETE` はトランザクション管理と合わせて使うと安全。
- 例：営業部に新しいメンバーを追加し、直後に確認する。
```sql
BEGIN TRANSACTION;
INSERT INTO employees (id, name, age, department, salary, joined_at)
VALUES (6, 'Frank', 26, 'Sales', 390000, '2024-02-14');
SELECT id, name, department, salary FROM employees WHERE id = 6;
ROLLBACK;
```
| id | name  | department | salary |
|----|-------|------------|--------|
| 6  | Frank | Sales      | 390000 |

- 例：営業部の給与を5%引き上げて確認し、最後に取り消す。
```sql
BEGIN TRANSACTION;
UPDATE employees
SET salary = salary * 1.05
WHERE department = 'Sales';
SELECT name, salary FROM employees WHERE department = 'Sales';
ROLLBACK;
```
| name  | salary |
|-------|--------|
| Alice | 441000 |
| Carol | 525000 |
| Eve   | 577500 |

- 本番環境では `ROLLBACK` の代わりに `COMMIT` で変更を確定させる。

7. JOINによるテーブル結合
---------------------
- テーブルを正規化すると関連情報が別テーブルに分かれるため、`JOIN` で組み合わせる。
- `INNER JOIN` は両テーブルに存在する行だけを返し、`LEFT JOIN` は左側の全行を返した上でマッチしない部分を `NULL` にする。
- サンプルテーブル：
```sql
CREATE TABLE departments (
  id INTEGER PRIMARY KEY,
  department_name TEXT,
  manager TEXT
);

INSERT INTO departments (id, department_name, manager) VALUES
  (1, 'Sales', 'Grace'),
  (2, 'Marketing', 'Heidi'),
  (3, 'Engineering', 'Ivan'),
  (4, 'Support', 'Judy');
```
| id | department_name | manager |
|----|-----------------|---------|
| 1  | Sales           | Grace   |
| 2  | Marketing       | Heidi   |
| 3  | Engineering     | Ivan    |
| 4  | Support         | Judy    |

- `INNER JOIN` の例：
```sql
SELECT
  e.name,
  e.department,
  d.manager
FROM employees e
INNER JOIN departments d
  ON e.department = d.department_name
ORDER BY e.id;
```
| name  | department  | manager |
|-------|-------------|---------|
| Alice | Sales       | Grace   |
| Bob   | Marketing   | Heidi   |
| Carol | Sales       | Grace   |
| Dave  | Engineering | Ivan    |
| Eve   | Sales       | Grace   |

- `LEFT JOIN` の例：部署に所属メンバーをすべて表示し、いない場合は `NULL`。
```sql
SELECT
  d.department_name,
  e.name AS member_name
FROM departments d
LEFT JOIN employees e
  ON d.department_name = e.department
ORDER BY d.department_name, member_name;
```
| department_name | member_name |
|-----------------|-------------|
| Engineering     | Dave        |
| Marketing       | Bob         |
| Sales           | Alice       |
| Sales           | Carol       |
| Sales           | Eve         |
| Support         | NULL        |

